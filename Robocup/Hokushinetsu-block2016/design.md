# ロボカップ2016設計詳細

## 使用するマイコンとその内訳
- LPC1768(純正)
    - IO:26
        - PWM:6
        - I2C:2x2
- LPC1114
    - IO:17
        - PWM:4
        - I2C:2x1
- (NUCLEO-F303K8)
    - IO:21
        - PWM:12
        - I2C:2x1

## モジュール
- IRセンサ
- コンパスモジュール
- ラインセンサ
- 超音波センサ
- キッカー
- ドリブラ

## ピン使用
下記4つのモジュールに対して、１つずつマイコンを使用する
- メイン(LPC1768)
    - モータ I/O(2x3), PWM(1x3)
    - I2C(2x2)
        - コンパス
        - コントローラとの通信(address : 0x32)
        - IR処理マイコンとの通信(address : 0xA0)
        - 超音波センサ管理マイコンとの通信(address : 0xF0)
    - ライン I/O(1x4)
    - ドリブラ(モータ) I/O(2x1), PWM(1x1)
    - キッカー
        - IR I/O(1x1)
        - キッカー I/O(1x1)
    - デバッグ用LED
- IR(LPC1114)
    - I/O(1x12)
    - I/O far(1x2)
    - I2C(2x1)
        - メインマイコンとの通信
- 超音波(NUCLEO-F303K8)
    - 超音波 I/O(2x4)
    - I2C(2x1)
        - メインマイコンとの通信
- コントローラ(LPC1114)
    - モードの切り替え (ピン未定)
    - その他デバッグ (ピン未定)
    - I2C(2x1)
        - メインマイコンとの通信

## 設計
### メイン
- Classes
    - __Compass__
        - \# コンパスの管理
        - ディジタルコンパスモジュールによって取得した角度をmainに渡す
        - HMC6352クラスのラッパークラス
    - __Motor__
        - \# モータ制御
        - 一つのモータの制御を行う
    - (__MotorThreeWheeler__)
        - \# 三つのモータの制御(使うかどうか微妙。今のところ、必要性が見いだせない)
        - Motorクラスを包含している
        - 主に3輪ロボットのモータ制御を行う
    - __Kicker__
        - \# キッカーの制御
        - キックするべきか判断し、それに応じて動作させる
- main
    - \# すべてのマイコンとの通信および統括
    - Compassクラスから受け取った角度を元に、ロボットの方向の調整を行う
    - Motorクラスを用いて、ロボットを走らせる
    - IR用のマイコンから受け取った値を元に、ボールを追いかける
    - ラインセンサから受け取った値を用いてモータを制御し、アウト・オブ・バウンズを防ぐ
    - 超音波センサから受け取った値を用いてモータを制御し、アウト・オブ・バウンズを防ぐ
    - LED等を用いて、さまざまなデバッグを行う
    - コントローラマイコンから受け取った値を元に、モードの切り替えを行う
    - ボールがロボットの目の前に来て、キック命令が来たときにキックする

### IR
- main
    - \# IRセンサの管理
    - IRセンサから受け取った値を整理し、メインマイコンに送信する

### 超音波
- Classes
    - __Ultrasonic__
        - \# 超音波センサの管理
        - 超音波センサから受け取った値を評価し、それをmainに渡す
        - HCSR04クラスのラッパークラス
- main
    - \# 超音波センサの管理
    - Ultrasonicクラスから受け取った値をメインマイコンに送信する

### コントローラ
- Classes
    - __Control__
        - \# コントロールパネル
        - その他未定
- main
    - \# コントロールパネル
    - スイッチから受け取った値をメインマイコンに送信する。モード切り替えを行う

## Todo
- main
    - [ ] 大まかなアルゴリズム作成
    - [ ] 各モジュールの優先順位付け
    - [ ] コンパスの使いどころ
- IR
    - [x] アルゴリズム作成(small task)
- キッカー・ドリブラ
    - [x] 二つの兼ね合いを考える
    - [x] Kickerクラスの動作確認
    - [x] アルゴリズム作成
- 超音波
    - [x] アルゴリズム作成(small task)
- コントローラ
    - [x] このマイコンで他に何を行うか考える
    - モードの作成
        - [ ] Normal Mode
        - [ ] Keeper Mode
        - [ ] Line-Trace Mode
        - [ ] Kamikaze Mode
        - Debug Mode
            - [ ] IR
            - [ ] Ultrasonic
            - [ ] Line
    - [ ] アルゴリズム作成
- 実践的なこと
    - [ ] 足回りの調整
    - [ ] PID制御
    - [ ] 必要最小限を実装し、擬似的に動かす
- other
    - [ ] ノイズ除去
    - [x] 複数のデバイスでI2C通信を行う
    - [x] I2C通信をしながらpc.printfが出来るかどうか(Serial通信との兼ね合いで出来ない可能性)
    - [x] クラスからインスタンス名の取得
    - [x] リアルタイムOS

## 制御
### Normal Mode
通常時に使うモード。
コート外に出ないようにしつつ、ボールを追いかける。
このモードのしっかりとした実装ができなければ、他のモードを作ってもあまり価値はない。コンパスの使いどころがカギになると思われる。

- IRセンサのどれかがHighのときは、その方向に進む
- IRセンサがすべてLowのときの処理は未定
- 角度補正をいつするかは未定
- ラインセンサが反応したら止まって、超音波センサの値を読んで線の外に出ないように動く
- ロボットがいる位置によって、キッカーとドリブラのどちらを使うかを決定する

### Keeper Mode
コートの半分または四分の一より前に移動せず、横にもあまり移動しないことでOut of Boundsを防ぎ、守りを固める作戦。
あまり動かなすぎてもボールを取れないので、これの調整がカギ。
また、キッカーでボールを遠くに飛ばしてOut of Reachを誘ったり時間稼ぎをすることや、ドリブラでボールを保持して時間稼ぎをすることも視野に入れたい。

- ボールを追いかけるのは基本的に横方向のみ
- キッカーとドリブラの使い分けは未定

### Line-Trace Mode
相手がコート外に出ないように内側へ内側へ移動する挙動を逆手に取って、あえてライン上を進んでボールを取られないようにする方法。
相手によってはかなり有効な作戦になるかもしれないが、ラインの検出が完璧にできていないと自滅するので注意が必要。

- ボールを保持したら横にスライドして、ラインセンサが反応したら前進し、ある程度進んだら斜めを向いてキッカーを作動させる(そんなにうまくいくのか)

### Kamikaze Mode
基本的にはNormal Modeと同じだが、Out of Bounds対策をしないのが特徴。
こちらから何か仕掛けたいときなどに、まれに使うかもしれない。
もちろんリスクが高いので使う場面は限られると思われる。(使わないかもしれない)

### Debug Mode
- コンパス : 正面を向くように回転する
- キッカー : センサーが反応したらキックする
- ドリブラ : センサーが反応したらドリブラを回転させる
- ライン　 : 反応したらLEDを点灯させる

## メインアルゴリズム考察
- while(1)ループ内で動かすモジュール
    - IR
    - コンパス
    - 超音波
    - ドリブラ
- タイマ割り込み
    - 各種スイッチ類
    - ライン
    - キッカー
